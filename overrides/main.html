{% extends "base.html" %}

{% block extrahead %}
  {{ super() }}
  {% if page and page.meta and page.meta.date %}
    <style>
      .page-meta-date {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: var(--md-default-fg-color--light);
        margin: 0 0 1.2rem;
      }
      .page-meta-date__label {
        font-weight: 600;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        font-size: 0.7rem;
        color: var(--md-default-fg-color--light);
      }
      .page-meta-date time {
        font-variant-numeric: tabular-nums;
      }
      @media (max-width: 599px) {
        .page-meta-date {
          justify-content: flex-start;
        }
      }
    </style>
  {% endif %}
  {# Define fallbacks for 404 page where 'page' object is not available #}
  {% set page_title = page.title if page else "Page Not Found" %}
  {% set page_description = (page.meta.description if page and page.meta) or config.site_description %}
  {% set page_url = page.canonical_url if page else (config.site_url | string + '/404.html' | url) %}

  {# OGP Tags #}
  <meta property="og:type" content="{{ 'article' if page and page.file else 'website' }}">
  <meta property="og:title" content="{{ page_title }}">
  <meta property="og:description" content="{{ page_description }}">
  <meta property="og:url" content="{{ page_url }}">
  <meta property="og:site_name" content="{{ config.site_name }}">

  {# OGP Image Logic #}
  {% set image_url = (page.meta.image if page and page.meta else None) or config.extra.default_image %}
  {% if image_url %}
    {% if not image_url.startswith('http') %}
      {% set image_url = (config.site_url | string) + (image_url | url) %}
    {% endif %}
    <meta property="og:image" content="{{ image_url }}">
    <meta name="twitter:image" content="{{ image_url }}">
  {% endif %}

  {# Twitter Card Tags #}
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ page_title }}">
  <meta name="twitter:description" content="{{ page_description }}">

  {# Render structured data only for actual content pages #}
  {% if page and page.file %}
    {# Article JSON-LD #}
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "{{ page_title }}",
        "description": "{{ page_description }}",
        "url": "{{ page_url }}",
        "datePublished": "{{ (page.meta.date if page.meta else None) or '' }}",
        "author": {
          "@type": "Person",
          "name": "{{ (page.meta.author if page.meta else None) or config.extra.author or '' }}"{% if config.extra.author_alternate %},
          "alternateName": "{{ config.extra.author_alternate }}"{% endif %}{% if config.extra.author_sameas %},
          "sameAs": [
            {% for url in config.extra.author_sameas %}"{{ url }}"{% if not loop.last %}, {% endif %}{% endfor %}
          ]{% endif %}
        }
      }
    </script>
    {# Breadcrumb JSON-LD (Corrected) #}
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "ホーム",
            "item": "{{ config.site_url or '/' }}"
          }
          {% for nav_item in page.ancestors %}
          ,{
            "@type": "ListItem",
            "position": {{ loop.index + 1 }},
            "name": "{{ nav_item.title }}",
            "item": "{{ nav_item.canonical_url or page_url }}"
          }
          {% endfor %}
          {% if not page.is_homepage %}
          ,{
            "@type": "ListItem",
            "position": {{ page.ancestors | length + 2 }},
            "name": "{{ page_title }}",
            "item": "{{ page_url }}"
          }
          {% endif %}
        ]
      }
    </script>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if page and page.meta and page.meta.date %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var article = document.querySelector('.md-content__inner.md-typeset');
        if (!article) {
          return;
        }
        var heading = article.querySelector('h1');
        var meta = article.querySelector('.page-meta-date[data-page-date]');
        if (!heading || !meta) {
          return;
        }
        heading.insertAdjacentElement('afterend', meta);
      });
    </script>
  {% endif %}
{% endblock %}


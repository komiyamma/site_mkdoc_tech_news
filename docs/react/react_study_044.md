# 第44章：リスト表示における `key` の重要性

前章で「リスト表示には `key` が必要」と言いました。
VS Codeでも `key` がないと警告が出ますし、コンソールにも "Warning: Each child in a list should have a unique 'key' prop." と赤字が出ます 🚨

なぜこんなに `key` が大事なのでしょうか？
適当に `index` を使うとなぜダメなのでしょうか？
その理由を解き明かします 🗝️

---

## 1. `key` は React のための「名札」 📛

Reactは、前の画面と今の画面を比較して、**「どこが変わったか？」** を探します（差分検出）。

リストの中に要素がたくさんあるとき、
「あ、並び順が変わったな」とか「この要素だけ消えたな」と判断するために、
Reactは各要素につけられた **`key`（IDのようなもの）** を目印にします。

もし `key` がないと、Reactはどれがどれだか分からなくなり、
**リスト全体を無駄に作り直したり、予期せぬバグ（入力内容がズレるなど）** を引き起こします 😱

---

## 2. 絶対にユニーク（一意）なIDを使おう 🆔

`key` には、兄弟要素の中で **重複しない値** を渡す必要があります。
通常は、データが持っている **DBのID (`id`, `uuid` など)** を使うのがベストです。

```tsx
// ⭕️ 良い例
{users.map((user) => (
  <UserCard key={user.id} name={user.name} />
))}
```

これなら、もし並び順が変わっても、`id` は変わらないので、
Reactは「あ、`id: 1` の田中さんが3番目に移動したんだな」と正しく認識できます ✨

---

## 3. `index` (配列の添字) を `key` にするのはダメ？ 🙅‍♂️

よくやってしまいがちなのがこれです。

```tsx
// ⚠️ 注意が必要な例
{items.map((item, index) => (
  <li key={index}>{item}</li>
))}
```

`map` の第2引数 `index` (0, 1, 2...) を `key` にすることです。
**「リストが静的で、絶対に並び替えたり削除したりしない」** ならOKですが、
そうでない場合はバグの元です。

### なぜダメ？ 🤯

例えば `["A", "B", "C"]` というリストの先頭に `"Z"` を追加したとします。

1. **変更前**: `A(key=0)`, `B(key=1)`, `C(key=2)`
2. **変更後**: `Z(key=0)`, `A(key=1)`, `B(key=2)`, `C(key=3)`

Reactから見ると、
「key=0 の中身が A から Z に変わった！」
「key=1 の中身が B から A に変わった！」
…と、**全部の要素が別物に書き換わった**ように見えてしまいます。

もし `<input>` などで入力を保持していた場合、
**入力内容が勝手にズレたり、消えたりする** という怪奇現象が起きます 👻

---

## 4. `key` をつける場所 📍

`map` の直下にある要素（一番外側のタグ）につけます。

```tsx
// ⭕️ OK: 一番外側の div につける
{items.map(item => (
  <div key={item.id} className="card">
    <h2>{item.title}</h2>
  </div>
))}

// ❌ NG: 内側の h2 につけても意味がない
{items.map(item => (
  <div className="card">
    <h2 key={item.id}>{item.title}</h2>
  </div>
))}
```

フラグメント `<>...</>` を使う場合は、省略形では `key` がつけられないので、
`<React.Fragment key={item.id}>...</React.Fragment>` と書く必要があります 📝

---

## 5. まとめ 🌟

* リスト表示 (`map`) には必ず **`key`** プロパティをつける。
* `key` はそのリスト内で **一意（ユニーク）** でなければならない。
* データが持っている **`id`** を使うのがベスト 👍
* **`index` を `key` にするのは最終手段**（並び替え・削除があるリストでは絶対NG）。
* `key` があるおかげで、Reactは高速かつ正確に画面を更新できる ✨

次は、リスト表示と並んでよく使う
**「条件付きレンダリング（if文的なやつ）」** について学びます。
`&&` や三項演算子を使いこなして、表示を出し分けましょう！ 🚦
# ç¬¬28ç« ï¼š3æœ¬æŸ±ã‚’â€œåŒã˜å°ç·šâ€ã§ã¤ãªã ğŸ§©ğŸ”—âœ¨

ï¼ˆãƒ­ã‚°ğŸªµï¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ğŸ“ˆï¼ãƒˆãƒ¬ãƒ¼ã‚¹ğŸ§µã‚’ã€Œè¿·ã‚ãšè¡Œãæ¥ã§ãã‚‹çŠ¶æ…‹ã€ã«ã™ã‚‹å›ã ã‚ˆã€œï¼ï¼‰

---

## 0. ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ« ğŸ¯âœ¨

ã“ã®ç« ãŒçµ‚ã‚ã‚‹ã¨ã€ã“ã‚“ãªã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆğŸ‘‡

* ã€Œé…ã„ğŸ˜µã€ã€Œè½ã¡ãŸğŸ’¥ã€ã£ã¦è¨€ã‚ã‚ŒãŸã¨ãã«ã€**è¿·ã‚ãšè¾¿ã‚‹â€œèª¿æŸ»ãƒ«ãƒ¼ãƒˆâ€**ãŒä½œã‚Œã‚‹ğŸ§­âœ¨
* **ãƒ¡ãƒˆãƒªã‚¯ã‚¹ â†’ ãƒ­ã‚° â†’ ãƒˆãƒ¬ãƒ¼ã‚¹**ãŒã€**åŒã˜ID/åŒã˜è¨€è‘‰**ã§ã¤ãªãŒã‚‹ğŸ”—
* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ç‚¹ğŸ“ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ã¸é£›ã‚“ã ã‚Šã€ãƒ­ã‚°ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ã¸é£›ã‚“ã ã‚Šã§ãã‚‹ï¼ˆè¨­è¨ˆã®è€ƒãˆæ–¹ãŒã‚ã‹ã‚‹ï¼‰âœ¨
* å®Ÿè£…ã§ã¯ã€ã¾ãš **ãƒ­ã‚°ã« traceId/spanId ã‚’å…¥ã‚Œã‚‹**ã¨ã“ã‚ã¾ã§ã§ãã‚‹ğŸ”§ğŸªµğŸ§µ

---

## 1. ã¾ãšå¤§äº‹ãªè€ƒãˆæ–¹ï¼šè¦³æ¸¬ã¯ã€Œé‡ã€ã˜ã‚ƒãªãã¦ã€Œå°ç·šã€ğŸ‘€ğŸ§ âœ¨

ãƒ­ã‚°ã‚’å¢—ã‚„ã™ğŸ“šï¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹å¢—ã‚„ã™ğŸ“Šï¼ãƒˆãƒ¬ãƒ¼ã‚¹å¢—ã‚„ã™ğŸ§µï¼
â€¦ã‚‚å¤§äº‹ãªã‚“ã ã‘ã©ã€åˆå¿ƒè€…ãŒä¸€ç•ªã¤ã¾ãšãã®ã¯ã“ã“ğŸ‘‡

> **â€œãã‚Œãã‚Œè¦‹ãˆã¦ã‚‹ã‘ã©ã€ã¤ãªãŒã‚‰ãªã„â€å•é¡Œ** ğŸ˜­ğŸ”Œ

* ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã€Œé…ã„ã€ã£ã¦åˆ†ã‹ã‚‹ğŸ“ˆ
* ãƒ­ã‚°ã¯å¤§é‡ã«ã‚ã‚‹ğŸªµ
* ãƒˆãƒ¬ãƒ¼ã‚¹ã‚‚è¦‹ã‚Œã‚‹ğŸ§µ
* ã§ã‚‚ã€Œã“ã®é…ã•ã®ãƒ­ã‚°ã©ã‚Œï¼Ÿã€ã€Œã“ã®ã‚¨ãƒ©ãƒ¼ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã©ã‚Œï¼Ÿã€ã§è¿·å­ ğŸ« 

ã ã‹ã‚‰ã“ã®ç« ã¯ã€**3æœ¬æŸ±ã‚’1æœ¬ã®èª¿æŸ»ãƒ«ãƒ¼ãƒˆã«æŸã­ã‚‹è¨­è¨ˆ**ã‚’ã‚„ã‚‹ã‚ˆğŸ§©ğŸ”—âœ¨

---

## 2. â€œã¤ãªãâ€ãŸã‚ã®æœ€é‡è¦ã‚¢ã‚¤ãƒ†ãƒ ï¼šå…±é€šID ğŸ”‘ğŸ”—

çµè«–ã‹ã‚‰è¨€ã†ã­ğŸ‘‡

### âœ… ä¸»å½¹ã¯ traceIdï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹IDï¼‰ã§OKï¼

Webã®ä¸–ç•Œã§ã¯ã€åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã®æ–‡è„ˆã‚’HTTPãƒ˜ãƒƒãƒ€ã§é‹ã¶ãŸã‚ã« **W3C Trace Context** ãŒæ¨™æº–ã«ãªã£ã¦ã‚‹ã‚ˆğŸŒâœ¨
ãã®ä¸­å¿ƒãŒ `traceparent` ã§ã€**trace-id / parent-id / flags** ãªã©ã®æƒ…å ±ã‚’æŒã¤ã®ğŸ§µğŸ“¦ ([W3C][1])

#### ã‚ˆãã‚ã‚‹è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãŠã™ã™ã‚ï¼‰ğŸ’¡

* **traceId**ï¼šåˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚¹ã®ä¸»ã‚­ãƒ¼ï¼ˆå…¨ã‚µãƒ¼ãƒ“ã‚¹å…±é€šã®â€œæ—…ã®ãƒã‚±ãƒƒãƒˆâ€ï¼‰ğŸ§µğŸ«
* **requestId**ï¼šäººé–“ãŒè¦‹ã‚„ã™ã„/çŸ­ã„IDï¼ˆä»»æ„ï¼‰ğŸªª

  * ã§ã‚‚äºŒé‡é‹ç”¨ã§è¿·å­ã«ãªã‚Šã‚„ã™ã„ã‹ã‚‰ã€æœ€åˆã¯ **traceIdã‚’ä¸»**ã«ã™ã‚‹ã¨å®‰å®šğŸ‘

---

## 3. â€œåŒã˜è¨€è‘‰â€ã§æƒãˆã‚‹ï¼šå…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¾æ›¸ ğŸ“šğŸ·ï¸âœ¨

ã¤ãªãŒã‚‰ãªã„åŸå› ã®8å‰²ã¯ã€Œåå‰ãƒãƒ©ãƒãƒ©ã€å•é¡ŒğŸ˜µâ€ğŸ’«
ãªã®ã§ã€**ãƒ­ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹ã§åŒã˜æ„å‘³ã‚’åŒã˜ã‚­ãƒ¼å**ã§æƒãˆã‚‹ã‚ˆï¼

### âœ… ã¾ãšã¯ã“ã®10å€‹ã‚’â€œå›ºå®šã‚»ãƒƒãƒˆâ€ã«ã—ã‚ˆ ğŸ§·âœ¨

ï¼ˆæœ€åˆã‹ã‚‰å®Œç’§ã‚’ç›®æŒ‡ã•ãšã€ã“ã“ã ã‘æ­»å®ˆã§OKğŸ™†â€â™€ï¸ï¼‰

| keyï¼ˆãŠã™ã™ã‚ï¼‰                | æ„å‘³                          | ã©ã“ã§ä½¿ã†         |
| ------------------------ | --------------------------- | ------------- |
| `service.name`           | ã‚µãƒ¼ãƒ“ã‚¹å                       | å…¨éƒ¨            |
| `service.version`        | ãƒãƒ¼ã‚¸ãƒ§ãƒ³/ãƒ“ãƒ«ãƒ‰                   | å…¨éƒ¨            |
| `deployment.environment` | prod/stg/dev ãªã©             | å…¨éƒ¨            |
| `trace_id`               | traceIdï¼ˆä¸»å½¹ï¼‰                 | ãƒ­ã‚°/ãƒ¡ãƒˆãƒªã‚¯ã‚¹/ãƒˆãƒ¬ãƒ¼ã‚¹ |
| `span_id`                | spanId                      | ãƒ­ã‚°/ãƒˆãƒ¬ãƒ¼ã‚¹       |
| `http.method`            | GET/POST                    | å…¨éƒ¨ï¼ˆHTTPç³»ï¼‰     |
| `http.route`             | `/users/:id` ã¿ãŸã„ãªâ€œãƒ«ãƒ¼ãƒˆâ€      | å…¨éƒ¨ï¼ˆè¶…é‡è¦ï¼‰       |
| `http.status_code`       | 200/500 ãªã©                  | å…¨éƒ¨            |
| `error.type`             | ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ï¼ˆä¾‹: `ValidationError`ï¼‰ | ãƒ­ã‚°/ãƒˆãƒ¬ãƒ¼ã‚¹       |
| `error.message`          | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆçŸ­ã‚æ¨å¥¨ï¼‰                 | ãƒ­ã‚°/ãƒˆãƒ¬ãƒ¼ã‚¹       |

OpenTelemetry ã¯ HTTP ã®å±æ€§ãƒ»ã‚¹ãƒ‘ãƒ³å‘½åãªã©ã® **ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯è¦ç´„ï¼ˆsemantic conventionsï¼‰** ã‚’ç”¨æ„ã—ã¦ã‚‹ã‹ã‚‰ã€ãã‚Œã«å¯„ã›ã‚‹ã¨å°†æ¥ãƒ©ã‚¯ã ã‚ˆâœ¨ï¼ˆHTTPã®å±æ€§/HTTPã‚¹ãƒ‘ãƒ³è¦ç´„ï¼‰([OpenTelemetry][2])

---

## 4. èª¿æŸ»å°ç·šã‚’ã€Œ3ã‚¹ãƒ†ãƒƒãƒ—ã€ã«å›ºå®šã™ã‚‹ ğŸ§­âœ¨

ç¬¬28ç« ã®ãƒŸãƒ‹æ¼”ç¿’ã«ã‚‚ã‚ã‚‹ã‚„ã¤ï¼ã“ã“ãŒè¶…ã‚³ã‚¢ã ã‚ˆğŸ”¥

### âœ… èª¿æŸ»ã¯ã“ã®3ã‚¹ãƒ†ãƒƒãƒ—ã§å›ºå®š ğŸ‘‡

**Step 1ï¼šãƒ¡ãƒˆãƒªã‚¯ã‚¹ğŸ“ˆ**
ã€Œã„ã¤ã‹ã‚‰ãƒ»ã©ã®APIãŒãƒ»ã©ã‚Œãã‚‰ã„ã€ãŠã‹ã—ã„ï¼Ÿï¼ˆå…¨ä½“åƒï¼‰

**Step 2ï¼šãƒ­ã‚°ğŸªµ**
ã€Œè©²å½“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆtraceIdï¼‰ã‚’1ã¤â€œç‰¹å®šâ€ã€ã™ã‚‹ï¼ˆè¨¼æ‹ é›†ã‚ï¼‰

**Step 3ï¼šãƒˆãƒ¬ãƒ¼ã‚¹ğŸ§µ**
ãã® traceId ã®æ—…ã‚’è¦‹ã¦ã€Œã©ã“ã§æ™‚é–“/å¤±æ•—ãŒèµ·ããŸã‹ã€ç¢ºå®šï¼ˆçŠ¯äººç‰¹å®šï¼‰

---

## 5. â€œé£›ã¹ã‚‹â€ã¨æœ€å¼·ï¼šãƒ¡ãƒˆãƒªã‚¯ã‚¹â†”ãƒˆãƒ¬ãƒ¼ã‚¹ã®ãƒªãƒ³ã‚¯ï¼ˆExemplarsï¼‰ğŸ“ğŸ§µâœ¨

ã“ã“ã€ä»Šã©ãæ„Ÿã¤ã‚ˆã„ã‚ˆã€œï¼ğŸ˜†âœ¨

### âœ… Exemplarsï¼ˆä¾‹ç¤ºãƒ‡ãƒ¼ã‚¿ï¼‰ã£ã¦ãªã«ï¼Ÿ

ã–ã£ãã‚Šè¨€ã†ã¨ğŸ‘‡

> **ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®â€œç‚¹â€ã« traceId ã‚’ã¶ã‚‰ä¸‹ã’ã‚‹**ğŸ“ˆğŸ“â¡ï¸ğŸ§µ

Grafana ã§ã¯ exemplars ã®ä»•çµ„ã¿ãŒèª¬æ˜ã•ã‚Œã¦ã¦ã€**ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ã¸ã‚¸ãƒ£ãƒ³ãƒ—**ãŒã§ãã‚‹ã‚ˆâœ¨ ([Grafana Labs][3])
ã•ã‚‰ã« Tempo å´ã§ã‚‚ã€metrics-generator ãŒ exemplars ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ â€œmetricsâ†’trace linkingâ€ ã‚’åŠ©ã‘ã‚‹è©±ãŒã‚ã‚‹ã‚ˆğŸ§ âœ¨ ([Grafana Labs][4])

â€»æœ€åˆã‹ã‚‰å¿…é ˆã˜ã‚ƒãªã„ã‘ã©ã€**ã€Œå°ç·šè¨­è¨ˆã€ã®å®Œæˆå½¢**ã¨ã—ã¦çŸ¥ã£ã¦ãŠãã¨å¼·ã„ğŸ’ªâœ¨

---

## 6. å®Ÿè£…ãƒŸãƒ‹ï¼šãƒ­ã‚°ã« traceId/spanId ã‚’å…¥ã‚Œã¦â€œã¤ãªãŒã‚‹åœŸå°â€ã‚’ä½œã‚‹ ğŸªµğŸ§µğŸ”§

ã“ã“ã‹ã‚‰ã€Œå®Ÿéš›ã«ç¹‹ã’ã‚‹ã€ãƒ‘ãƒ¼ãƒˆã ã‚ˆã€œï¼ğŸ¥³

### 6.1 OpenTelemetryï¼ˆNodeï¼‰å´ã®è¿‘æ³ãƒ¡ãƒ¢ ğŸ§ âœ¨

* Nodeå‘ã‘SDKã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆ`@opentelemetry/sdk-node`ï¼‰ã¯ã€åŸ·ç­†æ™‚ç‚¹ã§ **0.210.0** ãŒæœ€æ–°ã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã‚‹ã‚ˆï¼ˆnpmè¡¨ç¤ºï¼‰([Npm][5])
* ãã—ã¦ OpenTelemetry JS SDK 2.x ã®æµã‚Œã¨ã—ã¦ã€å®‰å®šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ `>=2.0.0`ã€ä¸å®‰å®šç³»ã¯ `>=0.200.0` ã¨ã„ã†æ•´ç†ãŒèª¬æ˜ã•ã‚Œã¦ã‚‹ã‚ˆğŸ§©([OpenTelemetry][6])
* ãªãŠ Node ã® OpenTelemetry å…¬å¼Getting Startedã§ã¯ã€**ãƒ­ã‚°å‘ã‘ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã¾ã é–‹ç™ºä¸­**ã§ã€ãƒ­ã‚°ã®ä¾‹ã¯è¼‰ã›ã¦ãªã„ã‚ˆï¼ˆã ã‹ã‚‰å®Ÿå‹™ã§ã¯â€œãƒ­ã‚°ã«traceIdã‚’åŸ‹ã‚è¾¼ã‚€â€ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒè¶…é‡è¦ï¼‰ğŸªµğŸ§µ ([OpenTelemetry][7])
* OpenTelemetry JS ã¯ **Node.js ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹LTSã‚’ã‚µãƒãƒ¼ãƒˆ**ã£ã¦æ–¹é‡ã ã‚ˆğŸ§¡ ([OpenTelemetry][8])

---

### 6.2 ç›®æ¨™ï¼ˆå®Ÿè£…ã§ã‚„ã‚‹ã“ã¨ï¼‰ğŸ¯

* ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ä¸­ã® **ç¾åœ¨ã®Spanã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**ã‹ã‚‰

  * `traceId`
  * `spanId`
    ã‚’å–ã‚Šå‡ºã—ã¦ã€**æ§‹é€ åŒ–ãƒ­ã‚°ã«æ¯å›å…¥ã‚Œã‚‹**ğŸªµâœ¨

---

### 6.3 ã‚µãƒ³ãƒ—ãƒ«æ§‹æˆï¼ˆè¶…ãƒŸãƒ‹ï¼‰ğŸ§±

* `telemetry.ts`ï¼šOpenTelemetryåˆæœŸåŒ–
* `logger.ts`ï¼špinoç­‰ã®logger + â€œtraceIdã‚’æ³¨å…¥ã™ã‚‹é–¢æ•°â€
* `server.ts`ï¼šExpress APIï¼ˆ`/work`, `/slow`, `/fail`ï¼‰

---

### 6.4 ã‚³ãƒ¼ãƒ‰ä¾‹ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ğŸ§‘â€ğŸ’»âœ¨

#### telemetry.tsï¼ˆè¶…ã–ã£ãã‚Šï¼‰

```ts
import { NodeSDK } from "@opentelemetry/sdk-node";
import { getNodeAutoInstrumentations } from "@opentelemetry/auto-instrumentations-node";
// Exporterã¯ç’°å¢ƒã«ã‚ˆã‚ŠOTLP/Consoleãªã©ã«å·®ã—æ›¿ãˆOK

export const sdk = new NodeSDK({
  // traceExporter: ...
  // metricReader: ...
  instrumentations: [getNodeAutoInstrumentations()],
});

export async function startTelemetry() {
  await sdk.start();
}

export async function stopTelemetry() {
  await sdk.shutdown();
}
```

#### logger.tsï¼ˆâ€œä»Šã®traceIdâ€ã‚’ãƒ­ã‚°ã«å…¥ã‚Œã‚‹ï¼‰

```ts
import pino from "pino";
import { context, trace } from "@opentelemetry/api";

export const baseLogger = pino({
  level: process.env.LOG_LEVEL ?? "info",
});

export function withTraceContext(fields: Record<string, unknown> = {}) {
  const span = trace.getSpan(context.active());
  const spanCtx = span?.spanContext();

  return {
    ...fields,
    trace_id: spanCtx?.traceId,
    span_id: spanCtx?.spanId,
  };
}
```

#### server.tsï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«â€œtraceIdå…¥ã‚Šãƒ­ã‚°â€ã§æ›¸ãï¼‰

```ts
import express from "express";
import { startTelemetry } from "./telemetry";
import { baseLogger, withTraceContext } from "./logger";

async function main() {
  await startTelemetry();

  const app = express();

  app.get("/work", async (_req, res) => {
    baseLogger.info(withTraceContext({ event: "work.start" }), "work start");
    res.json({ ok: true });
  });

  app.get("/slow", async (_req, res) => {
    baseLogger.info(withTraceContext({ event: "slow.start" }), "slow start");
    await new Promise((r) => setTimeout(r, 800));
    baseLogger.info(withTraceContext({ event: "slow.end" }), "slow end");
    res.json({ ok: true });
  });

  app.get("/fail", async (_req, res) => {
    try {
      throw new Error("Boom!");
    } catch (e: any) {
      baseLogger.error(
        withTraceContext({
          event: "fail",
          error_type: e?.name,
          error_message: e?.message,
        }),
        "request failed"
      );
      res.status(500).json({ ok: false });
    }
  });

  app.listen(3000, () => baseLogger.info({ port: 3000 }, "listening"));
}

main().catch((e) => {
  baseLogger.fatal({ err: e }, "boot failed");
  process.exit(1);
});
```

âœ… ã“ã‚Œã§ãƒ­ã‚°ã« `trace_id` ãŒå…¥ã‚‹ã‚ˆã†ã«ãªã‚‹ã‹ã‚‰ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒä½œã‚Œã‚‹ã‚ˆğŸ‘‡

* ãƒ­ã‚°ã‹ã‚‰ trace_id ã‚’æ‹¾ã†ğŸªµğŸ”
* ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°UIã§ trace_id ã‚’æ¤œç´¢ã—ã¦é–‹ãğŸ§µâœ¨

---

## 7. ãƒŸãƒ‹æ¼”ç¿’ï¼ˆã“ã®ç« ã®æœ¬é¡Œï¼‰ğŸ“âœ¨

### æ¼”ç¿’Aï¼šã‚ãªãŸã®ã€Œå…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å›ºå®šã‚»ãƒƒãƒˆã€ã‚’æ±ºã‚ã‚‹ ğŸ·ï¸

ã•ã£ãã®10å€‹ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ã‚ãªãŸã®é¡ŒæAPIç”¨ã«å¾®èª¿æ•´ã—ã¦ã¿ã¦ã­ğŸ‘‡

* `service.name` ã¯ä½•ï¼Ÿ
* `http.route` ã¯ã©ã®ç²’åº¦ï¼Ÿï¼ˆ`/users/:id` ã§å›ºå®šã§ãã‚‹ï¼Ÿï¼‰
* `deployment.environment` ã®å€™è£œã¯ï¼Ÿï¼ˆdev/stg/prodï¼‰

ğŸ’¡AIã«é ¼ã‚€ãªã‚‰ï¼š
ã€Œã“ã®APIæ•™æï¼ˆ/work /slow /failï¼‰ã§ã€ãƒ­ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹å…±é€šã§æŒã¤ã¹ããƒ•ã‚£ãƒ¼ãƒ«ãƒ‰10å€‹ã‚’ã€å‘½åã‚†ã‚ŒãŒèµ·ããªã„ã‚ˆã†ã«ææ¡ˆã—ã¦ã€‚ç†ç”±ã‚‚1è¡Œãšã¤ã€‚ã€ğŸ¤–ğŸ“âœ¨

---

### æ¼”ç¿’Bï¼šã€Œ3ã‚¹ãƒ†ãƒƒãƒ—èª¿æŸ»æ‰‹é †ã€ã‚’1æšã«ã™ã‚‹ ğŸ§­ğŸ“„

ä¾‹ï¼š/slow ãŒé…ã„ã¨è¨€ã‚ã‚ŒãŸã¨ã

1. ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼šp95ä¸ŠãŒã£ã¦ã‚‹ï¼Ÿã©ã®routeï¼Ÿã„ã¤ã‹ã‚‰ï¼ŸğŸ“ˆ
2. ãƒ­ã‚°ï¼šåŒæ™‚åˆ»ã§ `http.route=/slow` ã®ãƒ­ã‚°ã‚’çµã‚‹ğŸªµ
3. ãƒˆãƒ¬ãƒ¼ã‚¹ï¼šãƒ­ã‚°ã® `trace_id` ã§è©²å½“ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’é–‹ã„ã¦ã€é…ã„spanã‚’è¦‹ã‚‹ğŸ§µ

ğŸ’¡AIã«é ¼ã‚€ãªã‚‰ï¼š
ã€Œ/slow ãŒé…ã„æ™‚ã®èª¿æŸ»ã‚’ â€œ3ã‚¹ãƒ†ãƒƒãƒ—â€ ã«å›ºå®šã—ã¦ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã§è¦‹ã‚‹ã¹ãæŒ‡æ¨™/ãƒ­ã‚°é …ç›®/ãƒˆãƒ¬ãƒ¼ã‚¹ã®è¦‹ã©ã“ã‚ã‚’ç®‡æ¡æ›¸ãã§ã€ğŸ¤–ğŸ§ âœ¨

---

### æ¼”ç¿’Cï¼š â€œé£›ã³å…ˆâ€ ã‚’è¨­è¨ˆã™ã‚‹ï¼ˆãƒªãƒ³ã‚¯è¨­è¨ˆï¼‰ğŸ”—

* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ğŸ“Šã‹ã‚‰ãƒ­ã‚°ğŸªµã¸ï¼šæœ€ä½é™ã€ä½•ã§çµã‚Œã‚‹ï¼Ÿï¼ˆrouteã€envã€serviceã€æ™‚é–“ï¼‰
* ãƒ­ã‚°ğŸªµã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ğŸ§µã¸ï¼šã©ã®ã‚­ãƒ¼ã§é£›ã¶ï¼Ÿï¼ˆ`trace_id`ï¼‰
* å°†æ¥ï¼šexemplarsã§ã€Œç‚¹ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ã¸ã€ğŸ“â¡ï¸ğŸ§µï¼ˆçŸ¥è­˜ã¨ã—ã¦æŠ¼ã•ãˆã‚‹ï¼‰([Grafana Labs][3])

---

## 8. ã‚ˆãã‚ã‚‹äº‹æ•…ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå…ˆã«æ½°ã™ï¼‰ğŸ’£ğŸ§¯

### ğŸ˜± äº‹æ•…1ï¼šrequestId ã¨ traceId ãŒåˆ¥é‹ç”¨ã§è¿·å­

â¡ï¸ **ä¸»å½¹ã¯1ã¤ã«æ±ºã‚ã‚‹**ï¼ˆè¿·ã£ãŸã‚‰ traceIdï¼‰ğŸ”—

### ğŸ˜± äº‹æ•…2ï¼š`http.route` ãŒãªãã¦ã€ãƒ­ã‚°ã‚‚ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚‚æ¤œç´¢ãŒåœ°ç„

â¡ï¸ â€œå®ŸURLâ€ã˜ã‚ƒãªãã¦ **ãƒ«ãƒ¼ãƒˆ**ï¼ˆ`/users/:id`ï¼‰ã‚’å…¥ã‚Œã‚‹ã®ãŒåŸºæœ¬ğŸ·ï¸âœ¨
ï¼ˆOTelã®HTTPè¦ç´„ã«å¯„ã›ã‚‹ã¨æœªæ¥ãŒãƒ©ã‚¯ï¼‰([OpenTelemetry][2])

### ğŸ˜± äº‹æ•…3ï¼šãƒ­ã‚°ã«traceIdå…¥ã£ã¦ãªã„

â¡ï¸ ã“ã®ç« ã®å®Ÿè£…ãƒŸãƒ‹ã§è§£æ±ºï¼ğŸªµğŸ§µâœ¨

---

## 9. ã¾ã¨ã‚ ğŸâœ¨

ã“ã®ç« ã®çµè«–ã¯ã“ã‚ŒğŸ‘‡

* 3æœ¬æŸ±ã‚’ã¤ãªãã«ã¯ **å…±é€šIDï¼ˆtraceIdï¼‰** ã¨ **å…±é€šèªå½™ï¼ˆå›ºå®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰** ãŒå‘½ğŸ”—
* èª¿æŸ»ã¯ **ãƒ¡ãƒˆãƒªã‚¯ã‚¹â†’ãƒ­ã‚°â†’ãƒˆãƒ¬ãƒ¼ã‚¹ã®3ã‚¹ãƒ†ãƒƒãƒ—**ã§å›ºå®šğŸ§­
* â€œé£›ã¹ã‚‹â€ã¨å¼·ã„ï¼šexemplars ãªã©ã§ **ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç‚¹â†’ãƒˆãƒ¬ãƒ¼ã‚¹**ãŒå®Ÿç¾ã§ãã‚‹ğŸ“ğŸ§µ ([Grafana Labs][3])
* ã¾ãšã¯å®Ÿå‹™çš„ã«ã€**ãƒ­ã‚°ã¸ trace_id/span_id ã‚’ç¢ºå®Ÿã«åŸ‹ã‚ã‚‹**ã¨ã“ã‚ã‹ã‚‰å§‹ã‚ã‚‹ğŸªµğŸ§µğŸ”§ï¼ˆOTel Nodeã¯ãƒ­ã‚°ãŒã¾ã ç™ºå±•é€”ä¸Šãªã®ã§ç‰¹ã«é‡è¦ï¼‰([OpenTelemetry][7])

---

æ¬¡ã®ç¬¬29ç« ã¯ã€ã“ã®å°ç·šã‚’â€œè¦‹ã‚„ã™ã„ç”»é¢â€ã«è½ã¨ã—è¾¼ã‚€ **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¨­è¨ˆğŸ“Šâœ¨** ã ã‚ˆï¼
ã€Œè¦‹ã‚‹é †ç•ªã€ã‚’å‹ã«ã—ã¦ã€è¿·å­ã‚¼ãƒ­ã«ã—ã¦ã„ã“ã€œï¼ğŸ˜†ğŸ§­ğŸ’•

[1]: https://www.w3.org/TR/trace-context/?utm_source=chatgpt.com "Trace Context"
[2]: https://opentelemetry.io/docs/specs/semconv/registry/attributes/http/?utm_source=chatgpt.com "HTTP Attributes"
[3]: https://grafana.com/docs/grafana/latest/fundamentals/exemplars/?utm_source=chatgpt.com "Introduction to exemplars | Grafana documentation"
[4]: https://grafana.com/docs/tempo/latest/metrics-from-traces/?utm_source=chatgpt.com "Metrics from traces | Grafana Tempo documentation"
[5]: https://www.npmjs.com/package/%40opentelemetry/sdk-node?utm_source=chatgpt.com "OpenTelemetry SDK for Node.js"
[6]: https://opentelemetry.io/blog/2025/otel-js-sdk-2-0/?utm_source=chatgpt.com "Announcing the OpenTelemetry JavaScript SDK 2.0"
[7]: https://opentelemetry.io/docs/languages/js/getting-started/nodejs/?utm_source=chatgpt.com "Node.js"
[8]: https://opentelemetry.io/ja/docs/languages/js/?utm_source=chatgpt.com "JavaScript"

# ç¬¬14ç« ã€€æ­£è¦åŒ–ï¼ˆNormalizationï¼‰ï¼šæ¤œè¨¼å‰ã«æ•´ãˆã‚‹ğŸ§¼âœ¨

## ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ğŸ¯ğŸ’–

* å…¥åŠ›ã®ã€Œã‚†ã‚Œã€ï¼ˆç©ºç™½ãƒ»å…¨è§’åŠè§’ãƒ»å¤§æ–‡å­—å°æ–‡å­—ãªã©ï¼‰ã‚’ã€**æ¤œè¨¼ã®å‰ã«**ãã‚ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ™‚âœ¨
* æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«ã‚’ã€Œã©ã“ã§ã€ã€Œã©ã®é †ã§ã€ã‹ã‘ã‚‹ã‹ã€è¿·ã‚ãªããªã‚‹ğŸšªğŸ›¡ï¸
* TypeScriptã§ **æ­£è¦åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**ã‚’ä½œã£ã¦ã€å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆVOï¼‰ã«ã¤ãªã’ã‚‰ã‚Œã‚‹ğŸ’ğŸ”—

---

## 1) æ­£è¦åŒ–ã£ã¦ãªã«ï¼ŸğŸ§½ğŸŒ€

æ­£è¦åŒ–ï¼ˆNormalizationï¼‰ã¯ã€ã–ã£ãã‚Šè¨€ã†ã¨â€¦

> **åŒã˜æ„å‘³ã®å…¥åŠ›ãªã‚‰ã€åŒã˜å½¢ï¼ˆcanonicalï¼‰ã«ãã‚ãˆã‚‹**ã“ã¨âœ¨

ä¾‹ğŸ‘‡

* `"  Alice  "` â†’ `"Alice"`ï¼ˆå‰å¾Œã®ç©ºç™½ãƒˆãƒªãƒ ï¼‰
* `"ï¼¡ï¼¢ï¼£ï¼‘ï¼’ï¼“"` â†’ `"ABC123"`ï¼ˆå…¨è§’â†’åŠè§’ï¼‰
* `"Test@Example.COM"` â†’ `"test@example.com"`ï¼ˆå°æ–‡å­—åŒ–ãƒãƒªã‚·ãƒ¼ï¼‰
* `"ï¾€ï¾›ï½³"` â†’ `"ã‚¿ãƒ­ã‚¦"`ï¼ˆåŠè§’ã‚«ãƒŠâ†’å…¨è§’ï¼‰

ã“ã®ã¸ã‚“ã¯JavaScriptã® `String.prototype.normalize()`ï¼ˆUnicodeæ­£è¦åŒ–ï¼‰ã§ã‚‚åŠ©ã‘ã‚‰ã‚Œã‚‹ã‚ˆğŸ«¶
ï¼ˆNFC / NFD / NFKC / NFKD ãŒã‚ã‚‹ã‚ˆï¼‰ ([MDN Web Docs][1])

---

## 2) ã€Œæ¤œè¨¼ã€ã¨ã€Œæ­£è¦åŒ–ã€ã£ã¦ä½•ãŒé•ã†ã®ï¼ŸğŸ¤”âœ…ğŸ§¼

* **æ­£è¦åŒ–**ï¼šå…¥åŠ›ã‚’â€œæ•´ãˆã‚‹â€ğŸ§¼ï¼ˆã‚†ã‚Œå¸åã€è¡¨è¨˜çµ±ä¸€ï¼‰
* **æ¤œè¨¼ï¼ˆvalidationï¼‰**ï¼šãƒ«ãƒ¼ãƒ«ã«åˆã£ã¦ã‚‹ã‹â€œãƒã‚§ãƒƒã‚¯ã™ã‚‹â€âœ…ï¼ˆå½¢å¼ãƒ»é•·ã•ãƒ»ç¯„å›²ãªã©ï¼‰

ã‚ã£ã¡ã‚ƒå¤§äº‹ãªé †ç•ªã¯ã“ã‚ŒğŸ‘‡
**æ­£è¦åŒ– â†’ æ¤œè¨¼ â†’ VOç”Ÿæˆï¼ˆcreate/parseï¼‰** ğŸ’ğŸ­

ãªãœã‹ã¨ã„ã†ã¨â€¦
**æ­£è¦åŒ–ã—ãªã„ã¾ã¾æ¤œè¨¼ã™ã‚‹ã¨ã€ã€Œæœ¬å½“ã¯OKãªã®ã«å¼¾ãã€äº‹æ•…**ãŒèµ·ããŒã¡ğŸ˜µâ€ğŸ’«ğŸ’¦
ï¼ˆä¾‹ï¼šå…¨è§’ï¼ ã€Œï¼ ã€å…¥ã‚Šãƒ¡ãƒ¼ãƒ«ã€æœ«å°¾ã‚¹ãƒšãƒ¼ã‚¹ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãªã©ï¼‰

---

## 3) ã©ã“ã§æ­£è¦åŒ–ã™ã‚‹ã®ï¼ŸãŠã™ã™ã‚ã¯2æ®µæ§‹ãˆğŸ°ğŸšª

æ­£è¦åŒ–ã¯ã€Œå¢ƒç•Œã€ã¨ã€ŒVOç”Ÿæˆç›´å‰ã€ã«ç½®ãã®ãŒå®‰å®šã ã‚ˆğŸ™‚âœ¨

### âœ…(A) å¢ƒç•Œï¼ˆBoundaryï¼‰ã§ã®æ­£è¦åŒ–ğŸšª

* UI / API / ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ãªã©ã€Œå¤–ã‹ã‚‰æ¥ãŸæ–‡å­—åˆ—ã€ã¯ã€ã¾ãšè»½ãæ•´ãˆã‚‹ğŸ§¼
* ä¾‹ï¼š`trim`ã€æ”¹è¡Œçµ±ä¸€ã€å…¨è§’ç©ºç™½â†’åŠè§’ç©ºç™½ã€ãªã©

### âœ…(B) VOã® `create/parse` å†…ã§â€œãã®å€¤å°‚ç”¨ã®æ­£è¦åŒ–â€ğŸ’

* Emailãªã‚‰Emailç”¨ã€ã‚¿ã‚°ãªã‚‰ã‚¿ã‚°ç”¨ã€ã¿ãŸã„ã«**å€¤ã”ã¨ã®æ­£è¦åŒ–ãƒãƒªã‚·ãƒ¼**ã‚’æœ€çµ‚ç¢ºå®šã™ã‚‹âœ¨
* â€œç„¡åŠ¹ãªçŠ¶æ…‹ã‚’ä½œã‚Œãªã„â€ã®æœ€å¾Œã®ç ¦ğŸ›¡ï¸ğŸ”¥

---

## 4) æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«ã¯ã€Œãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆ¥ã€ã«æ±ºã‚ã‚‹ã®ãŒã‚³ãƒ„ğŸ“Œâœ¨

ã€Œã¨ã‚Šã‚ãˆãšå…¨éƒ¨NFKCã§ã„ã„ã‚ˆã­ï¼ã€ã¯å±é™ºâš ï¸ğŸ˜‡ï¼ˆã‚ã¨ã§å›°ã‚‹ï¼‰

### ä»£è¡¨çš„ãªåˆ†é¡ğŸ±

* **è­˜åˆ¥å­ç³»ï¼ˆID / email / username / codeï¼‰**ï¼šæºã‚Œã‚’æ¸›ã‚‰ã—ã¦OKã«ã—ãŒã¡ğŸ‘
* **è¡¨ç¤ºåï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç­‰ï¼‰**ï¼šæºã‚Œã‚’æ®‹ã™ã“ã¨ã‚‚ã‚ã‚‹ï¼ˆâ€œè¦‹ãŸç›®â€ãŒå¤§äº‹ï¼‰ğŸ€
* **è‡ªç”±æ–‡ï¼ˆæœ¬æ–‡/ãƒ¡ãƒ¢ï¼‰**ï¼šåŸºæœ¬ã¯å¤‰ãˆã™ããªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ãŒå¤§äº‹ï¼‰ğŸ“
* **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ï¼šå‹æ‰‹ã«å¤‰æ›ã—ãªã„ï¼ˆçµ¶å¯¾ï¼‰ğŸ”ğŸ˜±

Unicodeã®äº’æ›æ­£è¦åŒ–ï¼ˆNFKC/NFKDï¼‰ã¯ä¾¿åˆ©ã ã‘ã©ã€**è¦‹ãŸç›®ã‚„æ„å‘³ãŒå¤‰ã‚ã‚‹**ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã‹ã‚‰ã€Œã©ã®é …ç›®ã«ä½¿ã†ã‹ã€æ±ºã‚ã¦ä½¿ã†ã®ãŒå®‰å…¨ã ã‚ˆğŸ§ âœ¨ ([unicode.org][2])

---

## 5) ã‚ˆãä½¿ã†æ­£è¦åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³10é¸ğŸ§°âœ¨

### â‘  å‰å¾Œã®ç©ºç™½ãƒˆãƒªãƒ ğŸ§¹

`trim()` ã¯è¶…å®šç•ªğŸ™‚ ([MDN Web Docs][3])

### â‘¡ é€£ç¶šç©ºç™½ã‚’1ã¤ã«ã™ã‚‹ğŸ§¼

åå‰ã‚„ä½æ‰€ãªã©ã€Œå†…éƒ¨ã®ç©ºç™½ã€ã‚’æ•´ãˆã‚‹ã¨ãã«ä½¿ã†ã‚ˆâœ¨

### â‘¢ æ”¹è¡Œã‚’çµ±ä¸€ï¼ˆCRLFâ†’LFï¼‰â†©ï¸

Windowsç”±æ¥ã® `\r\n` ã‚’ `\n` ã«ãã‚ãˆã‚‹ã®ã€åœ°å‘³ã«åŠ¹ãğŸ™‚

### â‘£ Unicodeæ­£è¦åŒ–ï¼ˆNFC / NFKCï¼‰ğŸŒ

`"ï½±"` ã¨ `"ã‚¢"`ã€`"ï¼‘ï¼’ï¼“"` ã¨ `"123"` ã¿ãŸã„ãªå·®ã‚’å¸åã—ã‚„ã™ã„âœ¨ ([MDN Web Docs][1])

### â‘¤ å¤§æ–‡å­—å°æ–‡å­—ã®çµ±ä¸€ğŸ”¤

ãŸã ã—ã€Œã©ã“ã¾ã§å°æ–‡å­—åŒ–ã™ã‚‹ã‹ã€ã¯ãƒãƒªã‚·ãƒ¼ï¼
ãƒ¡ãƒ¼ãƒ«ã¯ç‰¹ã«æ³¨æ„ï¼š**ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯DNSãƒ«ãƒ¼ãƒ«ã§å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„**ä¸€æ–¹ã€local-partã¯ä»•æ§˜ä¸Šã‚±ãƒ¼ã‚¹ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–æ‰±ã„ï¼ˆã§ã‚‚é‹ç”¨ä¸Šã¯åŒºåˆ¥ã—ãªã„ã“ã¨ãŒå¤šã„ï¼‰ã£ã¦ã„ã†ã‚„ã‚„ã“ã—ã•ãŒã‚ã‚‹ã‚ˆğŸ˜µâ€ğŸ’«
RFCä¸Šã¯ã€Œlocal-partã¯case-sensitiveã¨ã—ã¦æ‰±ã†å¿…è¦ãŒã‚ã‚‹ã€ãŒã€åŒæ™‚ã«ã€Œãã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã®ã¯ç›¸äº’é‹ç”¨æ€§ã‚’ä¸‹ã’ã‚‹ã®ã§æ¨å¥¨ã—ãªã„ã€ã¨ã‚‚æ›¸ã‹ã‚Œã¦ã‚‹ã‚ˆğŸ“©âš–ï¸ ([datatracker.ietf.org][4])

### â‘¥ ãƒã‚¤ãƒ•ãƒ³ãƒ»ã‚¹ãƒšãƒ¼ã‚¹é™¤å»ï¼ˆé›»è©±ç•ªå·ãªã©ï¼‰ğŸ“

`"090-1234-5678"` â†’ `"09012345678"`

### â‘¦ æ•°å­—ã®è¡¨è¨˜çµ±ä¸€ï¼ˆå…¨è§’â†’åŠè§’ï¼‰ğŸ”¢

IDãƒ»ã‚³ãƒ¼ãƒ‰ãƒ»éƒµä¾¿ç•ªå·ã§å¤§æ´»èºâœ¨

### â‘§ å…ˆé ­ã‚¼ãƒ­ã®æ‰±ã„ï¼ˆä»•æ§˜ã§æ±ºã‚ã‚‹ï¼‰0ï¸âƒ£

éƒµä¾¿ç•ªå·ã‚„ä¼šå“¡ç•ªå·ã¯ã€Œå…ˆé ­ã‚¼ãƒ­ãŒæ„å‘³ã‚’æŒã¤ã€ã“ã¨ãŒå¤šã„ã®ã§å‹æ‰‹ã«æ¶ˆã•ãªã„ï¼

### â‘¨ URLã®æ­£è¦åŒ–ï¼ˆã§ãã‚Œã°æ¨™æº–ã«ä»»ã›ã‚‹ï¼‰ğŸŒ

URLã¯ä»•æ§˜ãŒå¤šãã¦æ²¼ã‚Šã‚„ã™ã„ã®ã§ã€ã§ãã‚‹ã ã‘ WHATWG URL ãªã©â€œæ¨™æº–å®Ÿè£…â€å´ã«å¯„ã›ã‚‹ã®ãŒå®‰å…¨ğŸ™‚ ([url.spec.whatwg.org][5])

### â‘© ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šè¦‹ãŸç›®ãŒä¼¼ã¦ã‚‹æ–‡å­—ï¼ˆconfusableï¼‰å¯¾ç­–ğŸ›¡ï¸

ã€Œaã€ã¨ã€ŒĞ°ï¼ˆã‚­ãƒªãƒ«æ–‡å­—ï¼‰ã€ã¿ãŸã„ãªâ€œè¦‹ãŸç›®ãã£ãã‚Šâ€ã¯è©æ¬ºã«ã‚‚ä½¿ã‚ã‚Œã‚‹ã®ã§ã€è­˜åˆ¥å­ç”¨é€”ã§ã¯æ³¨æ„âš ï¸
Unicodeã‚‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ã‘ã®ä»•çµ„ã¿ï¼ˆconfusable detectionç­‰ï¼‰ã‚’å‡ºã—ã¦ã‚‹ã‚ˆğŸ§¯ ([unicode.org][6])

---

## 6) å®Ÿè£…ã—ã¦ã¿ã‚ˆã†ï¼šæ­£è¦åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ğŸ§ªâœ¨

### 6-1. å°ã•ãªé–¢æ•°ã‚’ç©ã¿ä¸Šã’ã‚‹ã®ãŒæœ€å¼·ğŸ§±ğŸ’ª

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã‚ŒğŸ‘‡

* **å‰¯ä½œç”¨ãªã—ï¼ˆpureï¼‰**
* **ä½•å›ã‹ã‘ã¦ã‚‚åŒã˜çµæœï¼ˆidempotentï¼‰**
* **ã€Œã©ã®é …ç›®ã«é©ç”¨ã™ã‚‹ã‹ã€ãŒæ˜ç¢º**

```ts
// normalizers.ts
export const trim = (s: string) => s.trim();

export const normalizeNFC = (s: string) => s.normalize("NFC");
export const normalizeNFKC = (s: string) => s.normalize("NFKC");

export const toLower = (s: string) => s.toLowerCase();

// é€£ç¶šç©ºç™½ã‚’1ã¤ã¸ï¼ˆå¿…è¦ãªé …ç›®ã ã‘ã«ä½¿ã†ï¼‰
export const collapseSpaces = (s: string) => s.replace(/\s+/g, " ");

// æ”¹è¡Œçµ±ä¸€ï¼ˆWindowsã® \r\n ã‚’ \n ã«ï¼‰
export const normalizeNewlines = (s: string) => s.replace(/\r\n/g, "\n");

// åˆæˆï¼ˆä¸Šã‹ã‚‰é †ã«é©ç”¨ï¼‰
export const pipe =
  (...fns: Array<(s: string) => string>) =>
  (input: string) =>
    fns.reduce((acc, fn) => fn(acc), input);
```

---

## 7) ä¾‹â‘ ï¼šEmailã®æ­£è¦åŒ–ï¼ˆãƒãƒªã‚·ãƒ¼ã‚’è¦‹ãˆã‚‹åŒ–ï¼‰ğŸ“©âœ¨

### 7-1. Emailã¯ã€Œè¡¨ç¤ºç”¨ã€ã¨ã€Œç…§åˆç”¨ã€ã‚’åˆ†ã‘ã‚‹ã¨æ¥½ğŸ˜Œ

ãŠã™ã™ã‚ã¯ğŸ‘‡

* `display`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥ã‚ŒãŸè¦‹ãŸç›®ï¼ˆè»½ãæ•´ãˆã‚‹ç¨‹åº¦ï¼‰
* `canonical`: ç…§åˆãƒ»æ¤œç´¢ãƒ»ä¸€æ„åˆ¶ç´„ã«ä½¿ã†çµ±ä¸€å½¢

### 7-2. Emailã®æ­£è¦åŒ–æ–¹é‡ï¼ˆä¾‹ï¼‰ğŸ§­

* å‰å¾Œç©ºç™½ã¯å‰Šã‚‹
* å…¨è§’â†’åŠè§’ã¯å¸åï¼ˆï¼ ã€è‹±æ•°ï¼‰
* **ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯å¿…ãšå°æ–‡å­—**ï¼ˆOKå¯„ã‚Šï¼‰
* local-partã¯ã€Œå°æ–‡å­—åŒ–ã™ã‚‹/ã—ãªã„ã€ã‚’æ±ºã‚ã‚‹

  * ãƒ­ã‚°ã‚¤ãƒ³IDç”¨é€”ãªã‚‰å°æ–‡å­—åŒ–ã—ã¡ã‚ƒã†ã“ã¨ãŒå¤šã„ï¼ˆé‹ç”¨å¯„ã‚Šï¼‰
  * ãŸã ã—ä»•æ§˜ä¸Šã®æ³¨æ„ã¯ç†è§£ã—ã¦ãŠãï¼ˆä¸Šã®RFCã®è©±ï¼‰ ([datatracker.ietf.org][4])

### 7-3. å®Ÿè£…ä¾‹ï¼ˆResultå‹ã¤ãï¼‰ğŸ

```ts
// result.ts
export type Ok<T> = { ok: true; value: T };
export type Err<E> = { ok: false; error: E };
export type Result<T, E> = Ok<T> | Err<E>;
export const ok = <T>(value: T): Ok<T> => ({ ok: true, value });
export const err = <E>(error: E): Err<E> => ({ ok: false, error });

// errors.ts
export type Issue = { code: string; message: string };

// email.ts
import { pipe, trim, normalizeNFKC } from "./normalizers";
import { Result, ok, err } from "./result";
import type { Issue } from "./errors";

export type Email = Readonly<{
  kind: "Email";
  display: string;
  canonical: string;
}>;

const normalizeEmailDisplay = pipe(
  normalizeNFKC, // å…¨è§’ï¼ ãªã©ã‚’å¸åï¼ˆé©ç”¨ã™ã‚‹ã®ã¯Emailã ã‘ï¼ï¼‰
  trim
);

// ã€Œç…§åˆç”¨ã€ï¼šç©ºç™½ã‚’æ¶ˆã™ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å°æ–‡å­—åŒ–â€¦ãªã©
const toCanonicalEmail = (display: string) => {
  const noSpaces = display.replace(/\s+/g, "");
  const at = noSpaces.indexOf("@");
  if (at < 0) return { local: "", domain: "", raw: noSpaces };

  const local = noSpaces.slice(0, at);
  const domain = noSpaces.slice(at + 1).toLowerCase(); // ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯å°æ–‡å­—
  // ğŸ‘‡ localã‚’å°æ–‡å­—åŒ–ã™ã‚‹ã‹ã¯â€œã‚ãªãŸã®ä»•æ§˜â€
  const canonical = `${local.toLowerCase()}@${domain}`;
  return { local, domain, raw: noSpaces, canonical };
};

export const Email = {
  create(input: string): Result<Email, Issue[]> {
    const display = normalizeEmailDisplay(input);

    const issues: Issue[] = [];
    if (display.length === 0) issues.push({ code: "empty", message: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç©ºã ã‚ˆğŸ¥º" });

    const { raw, canonical } = toCanonicalEmail(display);
    if (!raw.includes("@")) issues.push({ code: "format", message: "ã€Œ@ã€ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆğŸ“©ğŸ’¦" });

    // ã“ã“ã¯â€œè»½ã„å½¢å¼ãƒã‚§ãƒƒã‚¯â€ã®ä¾‹ï¼ˆæœ¬æ ¼ç‰ˆã¯ç« 19ã€œ21ã§ï¼ï¼‰
    if (raw.includes("..")) issues.push({ code: "format", message: "ã€Œ..ã€ã¯ã¡ã‚‡ã£ã¨æ€ªã—ã„ã‹ã‚‚ğŸ˜µâ€ğŸ’«" });

    if (issues.length > 0) return err(issues);

    return ok({
      kind: "Email",
      display,
      canonical,
    });
  },
} as const;
```

ğŸ“ãƒã‚¤ãƒ³ãƒˆ

* **æ­£è¦åŒ–ã—ãŸå¾Œ**ã«é•·ã•ã‚„å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚‹ï¼ˆé †ç•ªå¤§äº‹ï¼ï¼‰
* `canonical` ã®æ–¹é‡ï¼ˆlocalå°æ–‡å­—åŒ–ï¼‰ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ä»•æ§˜ã¨åˆã‚ã›ã¦æ±ºã‚ã‚‹ã®ãŒã‚³ãƒ„ã ã‚ˆğŸ™‚

---

## 8) ä¾‹â‘¡ï¼šã‚¿ã‚°ï¼ˆTagï¼‰ã®æ­£è¦åŒ–ğŸ·ï¸âœ¨

ã‚¿ã‚°ã¯ã€ŒåŒã˜æ„å‘³ãªã‚‰åŒã˜å½¢ã€ã«ã™ã‚‹ã¨UIã‚‚æ¤œç´¢ã‚‚æ°—æŒã¡ã„ã„ğŸ˜

ãƒãƒªã‚·ãƒ¼ä¾‹ğŸ‘‡

* `trim`
* ç©ºç™½ã¯ `_` ãªã©ã«çµ±ä¸€ï¼ˆã¾ãŸã¯å…¨éƒ¨æ¶ˆã™ï¼‰
* NFKCã§å…¨è§’è‹±æ•°ã‚’å¸å
* å°æ–‡å­—åŒ–ï¼ˆã‚¿ã‚°ã¯å°æ–‡å­—é‹ç”¨ãŒå¤šã„ï¼‰

```ts
import { pipe, trim, normalizeNFKC, toLower } from "./normalizers";
import { ok, err, type Result } from "./result";
import type { Issue } from "./errors";

export type Tag = Readonly<{ kind: "Tag"; value: string }>;

const normalizeTag = pipe(
  normalizeNFKC,
  trim,
  (s) => s.replace(/\s+/g, "_"),
  toLower
);

export const Tag = {
  create(input: string): Result<Tag, Issue[]> {
    const v = normalizeTag(input);

    const issues: Issue[] = [];
    if (v.length === 0) issues.push({ code: "empty", message: "ã‚¿ã‚°ãŒç©ºã ã‚ˆğŸ¥º" });
    if (v.length > 20) issues.push({ code: "too_long", message: "ã‚¿ã‚°ã¯20æ–‡å­—ã¾ã§ã«ã—ã‚ˆğŸ™‚" });
    if (!/^[a-z0-9_]+$/.test(v)) issues.push({ code: "chars", message: "ä½¿ãˆã‚‹ã®ã¯è‹±å°æ–‡å­—ãƒ»æ•°å­—ãƒ»_ ã ã‘ã ã‚ˆğŸ§¸" });

    return issues.length ? err(issues) : ok({ kind: "Tag", value: v });
  },
} as const;
```

---

## 9) ãƒ†ã‚¹ãƒˆè¦³ç‚¹ï¼šæ­£è¦åŒ–ã¯ãƒ†ã‚¹ãƒˆãŒè¶…ãƒ©ã‚¯ğŸ§ªğŸ˜

ç‰¹ã«ã“ã®2ã¤ã¯é‰„æ¿ã ã‚ˆğŸ‘‡

### âœ…(1) åŒã˜æ„å‘³ã®å…¥åŠ›ãŒåŒã˜ canonical ã«ãªã‚‹

* `" Test@Example.com "` ã¨ `"test@example.com"` ãŒåŒã˜ã«ãªã‚‹ï¼ŸğŸ™‚

### âœ…(2) idempotentï¼ˆä½•å›ã‹ã‘ã¦ã‚‚åŒã˜ï¼‰

* `normalize(normalize(x)) === normalize(x)` ã‚’æº€ãŸã™ï¼Ÿâœ¨
  ï¼ˆæ­£è¦åŒ–ãŒæš´ã‚Œãªã„ãƒã‚§ãƒƒã‚¯ï¼ï¼‰

---

## 10) ãƒŸãƒ‹èª²é¡ŒğŸ’âœ¨ï¼ˆä»Šæ—¥ã®ã¶ã‚“ï¼‰

### èª²é¡ŒAğŸ§¼

ã‚ãªãŸã®é¡Œæã§ã€Œå…¥åŠ›ã®ã‚†ã‚Œã€ã‚’3ã¤æ›¸ã„ã¦ã€æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«ã‚’æ±ºã‚ã¦ã­ğŸ™‚
ä¾‹ï¼š

* å‰å¾Œç©ºç™½
* å…¨è§’è‹±æ•°
* å¤§æ–‡å­—å°æ–‡å­—

### èª²é¡ŒBğŸ—ï¸

`pipe()` ã‚’ä½¿ã£ã¦ã€Œãã®é …ç›®å°‚ç”¨ã® normalize é–¢æ•°ã€ã‚’1ã¤ä½œã‚‹âœ¨
ï¼ˆEmailã§ã‚‚Tagã§ã‚‚OKï¼ï¼‰

### èª²é¡ŒCğŸ§ª

idempotentãƒ†ã‚¹ãƒˆã‚’1æœ¬æ›¸ãï¼
`normalize(normalize(x)) === normalize(x)` âœ…

---

## 11) AIæ´»ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ğŸ¤–ğŸ’¬âœ¨

ãã®ã¾ã¾ã‚³ãƒ”ãƒšã§ä½¿ãˆã‚‹ã‚„ã¤ç½®ã„ã¨ãã­ğŸ«¶

* ã€Œã“ã®å…¥åŠ›é …ç›®ã§èµ·ã“ã‚Šã†ã‚‹â€œè¡¨è¨˜ã‚†ã‚Œâ€ã‚’20å€‹å‡ºã—ã¦ğŸ·ï¸ğŸŒ€ã€
* ã€Œæ­£è¦åŒ–ã®å‰¯ä½œç”¨ï¼ˆæ„å‘³ãŒå¤‰ã‚ã‚‹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰ã‚’åˆ—æŒ™ã—ã¦âš ï¸ğŸ›¡ï¸ã€
* ã€Œæ­£è¦åŒ–â†’æ¤œè¨¼â†’VOç”Ÿæˆã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æˆåŠŸ/å¤±æ•—/å¢ƒç•Œå€¤ã§å‡ºã—ã¦ğŸ§ªâœ…ã€
* ã€Œã“ã®æ­£è¦åŒ–é–¢æ•°ãŒidempotentã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ã€åä¾‹ãŒã‚ã‚Œã°æ•™ãˆã¦ğŸ‘€ã€

---

## 12) ã¾ã¨ã‚ğŸŒ¸

* æ­£è¦åŒ–ã¯ã€ŒåŒã˜æ„å‘³ã‚’åŒã˜å½¢ã«ã€ãã‚ãˆã‚‹ä½œæ¥­ğŸ§¼âœ¨
* é †ç•ªã¯ **æ­£è¦åŒ– â†’ æ¤œè¨¼ â†’ VOç”Ÿæˆ** ãŒåŸºæœ¬ğŸ’
* `normalize()`ï¼ˆUnicodeæ­£è¦åŒ–ï¼‰ã¯ä¾¿åˆ©ã ã‘ã©ã€**ä½¿ã†é …ç›®ã‚’é¸ã¶**ã®ãŒå®‰å…¨ã ã‚ˆğŸŒğŸ›¡ï¸ ([MDN Web Docs][1])
* Emailã¯ç‰¹ã«ä»•æ§˜ã¨é‹ç”¨ã®ã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚‹ã‹ã‚‰ã€**ãƒãƒªã‚·ãƒ¼ã‚’æ±ºã‚ã¦canonicalã‚’æŒã¤**ã®ãŒå®‰å®šğŸ“©âœ¨ ([datatracker.ietf.org][4])

ï¼ˆã¡ãªã¿ã«æœ¬æ—¥æ™‚ç‚¹ã§ã¯ TypeScript ã®å®‰å®šç‰ˆã¯ 5.9.x ç³»ãŒæœ€æ–°ã¨ã—ã¦æ¡ˆå†…ã•ã‚Œã¦ã„ã‚‹ã‚ˆğŸ“£ï¼‰ ([github.com][7])

[1]: https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/String/normalize?utm_source=chatgpt.com "String.prototype.normalize() - JavaScript - MDN Web Docs"
[2]: https://unicode.org/reports/tr15/?utm_source=chatgpt.com "UAX #15: Unicode Normalization Forms"
[3]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/trim?utm_source=chatgpt.com "String.prototype.trim() - JavaScript - MDN Web Docs"
[4]: https://datatracker.ietf.org/doc/html/rfc5321?utm_source=chatgpt.com "RFC 5321 - Simple Mail Transfer Protocol - Datatracker - IETF"
[5]: https://url.spec.whatwg.org/?utm_source=chatgpt.com "URL Standard - WhatWG"
[6]: https://www.unicode.org/reports/tr39/?utm_source=chatgpt.com "UTS #39: Unicode Security Mechanisms"
[7]: https://github.com/microsoft/typescript/releases "Releases Â· microsoft/TypeScript Â· GitHub"
